# Annualizing benefits and costs

**This module will teach you how to use the `ecorest` and `EngrEcon` packages in `R` to efficiently and reproducibly calculate annualized benefits and costs for restoration project planning:**

*Authors: Ed Stowe (Writing, code), Darixa Hernandez-Abrams (benefits code), Kyle McKay (benefits code), Liya Abera (costs code) Cost annualization write-up from Utoy Creek: Kyle McKay, Stephen Phillips, Liya Abera, and Garrett Menichino*  
*Last update: `r as.Date(file.info('annualization.Rmd')$mtime)`*  
*Acknowledgements: *

## Background on annualization

Annualization is a technique for determining the costs and benefits of projects on an annual time scale, regardless of the overall time horizon of the project. Calculating annualized costs and benefits is an important component of restoration planning because it enables a fair comparison between alternative projects whose costs and/or benefits occur at different periods of time following implementation. 

## Annualizing benefits
Annualization of benefits can be easily carried out in the `ecorest` package. Along with `ecorest` we will also load the `tidyverse` package for plotting/wrangling and the `EngrEcon` package for cost annualization.

```{r, warning = FALSE, message = FALSE}
library(tidyverse)
library(ecorest)
library(EngrEcon)
```

Let's imagine a simple scenario with ecosystem or restoration benefits calculated at four time periods from year 0 to year 50. We can store these benefits in a dataframe and plot them with `ggplot` as follows:

```{r}
#User-specified time intervals
ben_df <- data.frame(year = c(0,2,20,50),
                     ben = c(0,100,90,80))

p <- ggplot(ben_df)+
  geom_point(aes(year, ben), size = 2)+
  geom_line(aes(year, ben))+
  labs(x = "Year", y = "Benefits")+
  theme_classic()
  
p
  
```
In essence, the total benefits of the project can be thought of as the area under this curve, which we can add to our plot using the `geom_area()` function.

```{r}
p <- p + 
  geom_area(aes(x = year, y = ben), 
            fill = "skyblue")

p
```

What annualization does is take the total shaded area under the benefits curve, and it divide by the number of years. This essentially looks like carving the area into triangles and rectangles, calculating the areas of these shapes and adding them together, and finally dividing to get an annual benefit. The `df_rect` code below simply creates a dataframe with the coordinates for two rectangles to add to our plot for visualization purposes.

```{r}
df_rect <- tibble(xmin = ben_df$year[2:3],
                  xmax = ben_df$year[3:4],
                  ymin = c(0,0),
                  ymax = ben_df$ben[3:4])

p + geom_rect(data = df_rect,
            aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax),
            fill = NA, lty = "dashed", color = "black")

```

The `ecorest` package provides an easy way to achieve this with the `annualizer` function, which computes "time-averaged quantities based on linear interpolation." Linear interpolation here just means that we connect the different points in time with straight lines. 

Inputs for the `annualizer` function are 1) a vector of time intervals and 
2) a vector of values to interpolate.

```{r}
annualizer(ben_df$year, ben_df$ben)
```
We can see, therefore, that the annualized ecological benefits of this toy project are 87.2 units (e.g., acres, etc.).

## Annualizing costs
Cost annualization is carried out so that fair comparisons can be made between projects with different temporal scales. 

To provide a real-world example of how to carry out cost annualization, we will use data from a feasibility study of potential restoration actions in Utoy Creek, a degraded watershed in Atlanta, GA. The USACEâ€™s Mobile District is partnering with the city of Atlanta to carry out the work. Cost effectiveness and Incremental Cost analysis (CEICA) were used to guide development of a recommended analysis and CEICA requires the use of annualized cost (and benefit) data. See the \@ref(ceica-chapter) for a full implementation of CEICA.

We will annualize cost data using the [EngrEcon](https://cran.r-project.org/web/packages/EngrEcon/index.html) R package. Note: a [web application](https://wrises.shinyapps.io/engrecon-webapp/) also exists for conducting these calculations that leverages the same R package. 

### Steps for annualization:

In order to carry out cost annualization, we will start by storing the federal discount rate of 2.75% in an object called `discount`. Then, we load the cost data and inspect it with the `str` function.

```{r, message = F}
# Set federal discont rate for water resources projects in FY24
discount <- 0.0275

# Read in initial costs
costs <- read_csv("data/utoy_cost.csv")

str(costs)
```

This dataset has three columns with cost info: `Project_first`, `Monitoring`, and `AdaptiveMan`, which refer to the costs of construction, monitoring and adaptive management, respectively.

operating, maintenance, repair and renewal costs

Calculate present value of OMRR costs using `om_distribute` function. This function...
```{r}
costs_omrrr <- costs %>%
  rowwise() %>%
  mutate(General = om_distribute(discount, 50, 1, 10000 * ifelse(RipAreaFt2>0, 1, 0)),
         InspectionTrash = om_distribute(discount, 50, 2, 4*ReachLengthFt),
         Invasives = om_distribute(discount, 50, 10, 15000 * ifelse(RipAreaFt2>0, 1, 0)),
         WoodRockEarth = om_distribute(discount, 50, 25, 0.1*ProjectFirst),
         TotalOMRR = InspectionTrash + General + Invasives + WoodRockEarth)


```

Now we have the present value of all costs in one dataframe: Project_first, Monitoring, AdapMan the same; OMRR costs from previous step

Calculate Interest during construction using  based on discount rate, duration of construction, and construction cost using the interest_during_construction function
```{r}
costs_idc <- costs_omrrr %>%
  rowwise() %>%
  mutate(IDC = case_when(DurationMon==0~0, TRUE ~ interest_during_construction(discount, DurationMon, ProjectFirst)))

```

Last step: annualize all costs using present_to_annual function using discount rate and 50 year time horizon
```{r}
costs_ann <- costs_idc %>% 
  rowwise() %>%
  mutate(ProjectFirstAnn = present_to_annual(discount, 50, ProjectFirst),
         IDCAnn = present_to_annual(discount, 50, IDC),
         MonitoringAnn = present_to_annual(discount, 50, Monitoring),
         AdManAnn = present_to_annual(discount, 50, AdMan),
         OMAnn = present_to_annual(discount, 50, TotalOMRR),
         TotalAnn = ProjectFirstAnn + MonitoringAnn + AdManAnn + IDCAnn + OMAnn)

```

Finally, we create a table to display the results. We use the `dollar()` function from the `scales` packages to format the cost columns in dollars.
```{r}
Table1 <- costs_ann %>%
  select(ReachID, SiteAction, DurationMon, ProjectFirst, Monitoring, AdMan, OMAnn, TotalAnn) %>%
  mutate(ProjectFirst = dollar(ProjectFirst), # Format as dollars with scales package
         Monitoring = dollar(Monitoring),
         AdMan = dollar(AdMan),
         OMAnn = dollar(OMAnn),
         TotalAnn = dollar(TotalAnn))

colnames(Table1) <- c("Site", "Alternative", "Construction Duration (mo)", 
                       "Construction Cost", "Monitoring Cost", "Adapative Mgmt. Cost",
                       "OMRRR Annual Cost", "Total Annualized Cost")

knitr::kable(Table1, caption="Table 1. Example of monetary cost data for Site-17F2M.", align='c') 

```

## Summary
* Annualizing costs and benefits is an important step so that apples-to-apples comparisons can be made among alternative projects that may oeprate on different time scales
* Annualizing benefits is simple to calculate using the `annualizer` function from the `ecorest` package
* Annualizing costs is more involved, but is also made considerably more manageable using the `EngrEcon` package
