<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>16 Generalized Linear Models | Using R for ecological modeling in USACE</title>
<meta name="author" content="Ed Stowe">
<meta name="generator" content="bookdown 0.42 with bs4_book()">
<meta property="og:title" content="16 Generalized Linear Models | Using R for ecological modeling in USACE">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="16 Generalized Linear Models | Using R for ecological modeling in USACE">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="This module will teach you how to use Generalized Linear Models to assess the importance of management-relevant environmental factors for fish species Authors: Ed StoweLast update:...">
<meta property="og:description" content="This module will teach you how to use Generalized Linear Models to assess the importance of management-relevant environmental factors for fish species Authors: Ed StoweLast update:...">
<meta name="twitter:description" content="This module will teach you how to use Generalized Linear Models to assess the importance of management-relevant environmental factors for fish species Authors: Ed StoweLast update:...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Using R for ecological modeling in USACE</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Course overview</a></li>
<li><a class="" href="required-set-up-for-the-course.html">Required set-up for the course</a></li>
<li class="book-part">Basic Training on R and RStudio</li>
<li><a class="" href="introduction-to-r-and-rstudio.html"><span class="header-section-number">1</span> Introduction to R and RStudio</a></li>
<li><a class="" href="data-visualization-with-ggplot2.html"><span class="header-section-number">2</span> Data Visualization with ggplot2</a></li>
<li><a class="" href="exploring-and-understanding-data.html"><span class="header-section-number">3</span> Exploring and understanding data</a></li>
<li><a class="" href="manipulating-tabular-data.html"><span class="header-section-number">4</span> Manipulating Tabular Data</a></li>
<li class="book-part">Ecological Modeling in R</li>
<li><a class="" href="conceptual-ecological-models.html"><span class="header-section-number">5</span> Conceptual Ecological Models</a></li>
<li><a class="" href="what-they-are-not.html"><span class="header-section-number">6</span> What they are not</a></li>
<li><a class="" href="misconceptions.html"><span class="header-section-number">7</span> Misconceptions</a></li>
<li><a class="" href="storytelling.html"><span class="header-section-number">8</span> Storytelling</a></li>
<li><a class="" href="art-of-conceptual-modeling-is-iterating.html"><span class="header-section-number">9</span> Art of conceptual modeling is iterating</a></li>
<li class="book-part">Habitat Models</li>
<li><a class="" href="background-on-habitat-models-in-usace.html"><span class="header-section-number">10</span> Background on habitat models in USACE</a></li>
<li><a class="" href="habitat-suitability-index-models-with-ecorest.html"><span class="header-section-number">11</span> Habitat Suitability Index models with ecorest</a></li>
<li><a class="" href="ecorest-web-app.html"><span class="header-section-number">12</span> Ecorest Web App</a></li>
<li><a class="" href="sensitivity-and-uncertainty-analysis-for-habitat-suitability-index-hsi-models.html"><span class="header-section-number">13</span> Sensitivity and uncertainty analysis for habitat suitability index (HSI) models</a></li>
<li><a class="" href="spatial-habitat-models.html"><span class="header-section-number">14</span> Spatial Habitat Models</a></li>
<li class="book-part">Linear Models</li>
<li><a class="" href="linear-models.html"><span class="header-section-number">15</span> Linear Models</a></li>
<li><a class="active" href="generalized-linear-models.html"><span class="header-section-number">16</span> Generalized Linear Models</a></li>
<li><a class="" href="random-effects.html"><span class="header-section-number">17</span> Random Effects</a></li>
<li><a class="" href="generalized-additive-models.html"><span class="header-section-number">18</span> Generalized Additive Models</a></li>
<li class="book-part">Machine Learning</li>
<li><a class="" href="random-forest.html"><span class="header-section-number">19</span> Random Forest</a></li>
<li><a class="" href="boosted-regression-trees.html"><span class="header-section-number">20</span> Boosted Regression Trees</a></li>
<li class="book-part">Other Modeling Approaches</li>
<li><a class="" href="population-modeling.html"><span class="header-section-number">21</span> Population Modeling</a></li>
<li><a class="" href="network-models-and-connectivity.html"><span class="header-section-number">22</span> Network Models and Connectivity</a></li>
<li><a class="" href="agent-based-models.html"><span class="header-section-number">23</span> Agent-based Models</a></li>
<li class="book-part">Models and decision-making</li>
<li><a class="" href="decision-support.html"><span class="header-section-number">24</span> Decision Support</a></li>
<li><a class="" href="annualizing-benefits-and-costs-with-ecorest-and-engrecon.html"><span class="header-section-number">25</span> Annualizing benefits and costs with ecorest and EngrEcon</a></li>
<li><a class="" href="ceica-chapter.html"><span class="header-section-number">26</span> Cost-Effectiveness and Incremental Cost Analysis (CEICA) with ecorest</a></li>
<li class="book-part">Models Integration</li>
<li><a class="" href="model-integration.html"><span class="header-section-number">27</span> Model Integration</a></li>
<li class="book-part">Other R applications</li>
<li><a class="" href="r-for-gis.html"><span class="header-section-number">28</span> R for GIS</a></li>
<li><a class="" href="intersect.html"><span class="header-section-number">29</span> Intersect</a></li>
<li><a class="" href="important-data-sources.html"><span class="header-section-number">30</span> Important data sources</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="generalized-linear-models" class="section level1" number="16">
<h1>
<span class="header-section-number">16</span> Generalized Linear Models<a class="anchor" aria-label="anchor" href="#generalized-linear-models"><i class="fas fa-link"></i></a>
</h1>
<p><strong>This module will teach you how to use Generalized Linear Models to assess the importance of management-relevant environmental factors for fish species</strong></p>
<p><em>Authors: Ed Stowe</em><br><em>Last update: 2025-02-03</em><br><em>Acknowledgements: Some inspiration/language/code have been used or adapted with permission from: Ben Staton’s <a href="https://bstaton1.github.io/au-r-workshop/ch3.html#glms">Intro to R for Natural Resources course</a>; and Quebec Center for biodiversity Science’s <a href="https://r.qcbs.ca/workshop06/book-en/">Generalized linear model workshop</a></em></p>
<div id="generalized-linear-model-background" class="section level2" number="16.1">
<h2>
<span class="header-section-number">16.1</span> Generalized Linear Model Background<a class="anchor" aria-label="anchor" href="#generalized-linear-model-background"><i class="fas fa-link"></i></a>
</h2>
<p>The models we examined in the previous section are linear models. They assume that the residuals are normally-distributed and that the response variable and the predictor variables are linearly-related. However several ubiquitous types of data used in ecological modeling–such as presence/absence data or counts of organisms–do not follow these assumptions. For these types of data, <strong>Generalized linear models (GLMs)</strong> can overcome these problems.</p>
<p>Here we will not go into all of the statistical details of GLMs, but for a more in-depth description of the statistical underpinnings, see [here] (<a href="https://r.qcbs.ca/workshop06/book-en/" class="uri">https://r.qcbs.ca/workshop06/book-en/</a>) and elsewhere. It is important to, however, to understand the three key elements of GLMs:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Response distribution</strong>: A probability distribution for the response variable Y, such as the binomial distribution for binary data or the Poisson distribution for count data.<br>
</li>
<li>
<strong>Linear predictor</strong>: A linear combination of explanatory variables (η=Xβ), analogous to a standard linear model.<br>
</li>
<li>
<strong>Link function</strong>: A function that relates the mean of the response variable’s distribution (μ) to the linear predictor (η). The choice of link function is typically guided by the response distribution; for example, count data modeled with a Poisson distribution often use the natural logarithm as the link function.</li>
</ol>
<p>The most common examples of GLMs in ecology are logistic regression for binary data or poisson and negative binomial regression for count data.</p>
</div>
<div id="logistic-regression" class="section level2" number="16.2">
<h2>
<span class="header-section-number">16.2</span> Logistic regression<a class="anchor" aria-label="anchor" href="#logistic-regression"><i class="fas fa-link"></i></a>
</h2>
<p><strong>Binary</strong> data, which have two opposite outcomes, is common in ecology, for example, present/absent, success/failure, lived/died, male/female, etc. If you want to predict how the probability of one outcome over its opposite changes depending on some other variable(s), then you need to use the <strong>logistic regression model</strong>, which is written as:</p>
<p><span class="math display" id="eq:logis-reg">\[\begin{equation}
  logit(p_i)=\beta_0 + \beta_1 x_{i1} + ... + \beta_j x_{ij}+ ... + \beta_n x_{in}, y_i \sim Bernoulli(p_i)
\tag{16.1}
\end{equation}\]</span></p>
<p>Here, <span class="math inline">\(p_i\)</span> is the probability of success for trial <span class="math inline">\(i\)</span> at the values of the predictor variables <span class="math inline">\(x_{ij}\)</span>. The <span class="math inline">\(logit(p_i)\)</span> is the <strong>link function</strong> that links the linear parameter scale to the data scale. The logit link function constrains the value of <span class="math inline">\(p_i\)</span> to be between 0 and 1 regardless of the values of the <span class="math inline">\(\beta\)</span> coefficients.</p>
<p>The logit link is equivalent to the log odds ratio, in other words, the natural log of how likely an event is compared to it not happening.</p>
<p>Therefore, with logistic regression, the model will calculate the log odds of an outcome, so if we want to know the odds ratio (i.e., ), we just take the inverse log. The example analysis that we conduct will make this more obvious.</p>
<div id="example-logistic-regression-anaysis" class="section level3" number="16.2.1">
<h3>
<span class="header-section-number">16.2.1</span> Example logistic regression anaysis<a class="anchor" aria-label="anchor" href="#example-logistic-regression-anaysis"><i class="fas fa-link"></i></a>
</h3>
<p>In our example logistic regression analysis, we’ll use the same fisheries dataset from three of the navigation pools in the Upper Mississippi River that we used in our chapter on linear models. These fish data are collected to understand long-term trends of the river, but we’ll use the data to see what relationships may exist between habitat predictors and fish responses.</p>
<div id="import-and-explore-data" class="section level4" number="16.2.1.1">
<h4>
<span class="header-section-number">16.2.1.1</span> Import and explore data<a class="anchor" aria-label="anchor" href="#import-and-explore-data"><i class="fas fa-link"></i></a>
</h4>
<p>First we read in the data filter it so that it only includes data from daylight electrofishing (<code>gear == "D"</code>), backwater habitat, and depths &lt; 5 m, as this is where this gear is most accurate.</p>
<div class="sourceCode" id="cb337"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org">tidyverse</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">umr_wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readr.tidyverse.org/reference/read_delim.html">read_csv</a></span><span class="op">(</span><span class="st">"data/umr_counts_wide.csv"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#Period already filtered to 3</span></span>
<span><span class="va">umr_sub</span> <span class="op">&lt;-</span>  <span class="va">umr_wide</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">gear</span> <span class="op">==</span> <span class="st">"D"</span>,</span>
<span>         <span class="va">stratum_full</span> <span class="op">==</span> <span class="st">"Backwater"</span>,</span>
<span>         <span class="va">depth</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p>Let’s look at the column names of our dataframe. We see that the last 10 columns, starting with BLGL are codes for species. These columns are counts of the different species in each sampling event.</p>
<div class="sourceCode" id="cb338"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">umr_sub</span><span class="op">)</span></span></code></pre></div>
<pre><code>##  [1] "date"         "utm_e"        "utm_n"        "stratum_full" "year"         "period"      
##  [7] "pool"         "gear"         "secchi"       "temp"         "depth"        "cond"        
## [13] "current"      "do"           "substrt"      "vegd"         "BLGL"         "FWDM"        
## [19] "CARP"         "LMBS"         "ERSN"         "BKCP"         "SHRH"         "GZSD"        
## [25] "WTBS"         "SFSN"</code></pre>
<p>Counts can be very “noisy” data and often difficult to predict, so it’s common to instead model presence/absence. In order to do this, we can convert our counts to 1’s and 0’s using the following code. Here we are using <code>mutate</code> to change the values of each of the species columns. <code>case_when</code> is a <code>dplyr</code> function that operates similarly to an if-else statement. So here, we are saying that in all the columns with species names, if the value is greater than 0, we convert this to 1, and if the value is not (i.e., if it’s 0), it will remain 0.</p>
<div class="sourceCode" id="cb340"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">species</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">umr_sub</span><span class="op">)</span><span class="op">[</span><span class="fl">17</span><span class="op">:</span><span class="fl">26</span><span class="op">]</span></span>
<span></span>
<span><span class="va">fish_binary</span> <span class="op">&lt;-</span> <span class="va">umr_sub</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">any_of</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span>, <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span><span class="va">.</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span>, <span class="cn">TRUE</span> <span class="op">~</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We’re going to examine whether any of the predictor variables in the dataset are predictive of the occurrence of one of the species, the common carp. Being able to predict habitat variables that influence the presence of a species might be the basis for predicting how USACE management activities impact species.</p>
<p>First, let’s plot common carp occurrence as a function of several predictor variables: temperature, water transparency (i.e., secchi disk reading), depth, and conductivity. To do this most easily with ggplot, we need all of the variables in one column so we can use the <code>facet_wrap</code> function to make a singe panel for each variable. To do this we create a dataframe called <code>carp_long</code> using the <code>pivot_longer</code> function to go from a wide format to a long format, which makes the plotting seemless.</p>
<div class="sourceCode" id="cb341"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">carp_long</span> <span class="op">&lt;-</span> <span class="va">fish_binary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">CARP</span>, <span class="va">secchi</span><span class="op">:</span><span class="va">do</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">secchi</span><span class="op">:</span><span class="va">cond</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span></span></code></pre></div>
<p>In <code>pivot_longer</code> we tell which columns we want to combine, what we should name the column that now inclues the variable names and what we should name the column that includes the variable values.</p>
<p>Now we can plot the variables.</p>
<div class="sourceCode" id="cb342"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">carp_long</span>, </span>
<span>         <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">CARP</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">.1</span>, width <span class="op">=</span> <span class="fl">.02</span>, alpha <span class="op">=</span><span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"steelblue"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>group <span class="op">=</span> <span class="va">CARP</span><span class="op">)</span>, </span>
<span>                   width <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, color <span class="op">=</span> <span class="st">"black"</span>, fill <span class="op">=</span> <span class="st">"gray"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>, nrow <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Value of predictor"</span>, y <span class="op">=</span> <span class="st">"Carp occurrence"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 170 rows containing non-finite outside the scale range
## (`stat_boxplot()`).</code></pre>
<pre><code>## Warning: Removed 170 rows containing missing values or values outside the scale range
## (`geom_point()`).</code></pre>
<div class="inline-figure"><img src="usace_R_training_files/figure-html/unnamed-chunk-54-1.png" width="600" height="600"></div>
<p>From these plots, a few variables pop out as being potentially important. For example locations with carp occurrences appear to have lower secchi disk readings (i.e., less clear water) and higher temperatures, but the strength of these relationships are unclear, which is where modeling comes in to play.</p>
</div>
<div id="fit-model-with-glm-function" class="section level4" number="16.2.1.2">
<h4>
<span class="header-section-number">16.2.1.2</span> Fit model with <code>glm</code> function<a class="anchor" aria-label="anchor" href="#fit-model-with-glm-function"><i class="fas fa-link"></i></a>
</h4>
<p>We’ll use the <code>glm</code> function in base R to do this, and the same kind of formula notation as with linear models, here indicating that we want to model carp occurrences as a function of four of our predictor variables. We’ll use the <code>fish_binary</code> dataset to do this. Finally we need to select a ‘family’ for the error distribution of our response variable. For presence/absence data, the binomial distribution is typically chosen because it’s a distribution with only two states, typically 1 for “success” and 0 for “failure.”</p>
<div class="sourceCode" id="cb345"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm.bin</span><span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">CARP</span> <span class="op">~</span> <span class="va">secchi</span> <span class="op">+</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">depth</span> <span class="op">+</span> <span class="va">cond</span>,</span>
<span>            data <span class="op">=</span> <span class="va">fish_binary</span>,</span>
<span>            family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span></span></code></pre></div>
<p>We can look at the results of the model with the <code>summary</code> function.</p>
<div class="sourceCode" id="cb346"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">glm.bin</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = CARP ~ secchi + temp + depth + cond, family = binomial, 
##     data = fish_binary)
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept) -1.2036029  0.5342537  -2.253  0.02427 *  
## secchi      -0.0322025  0.0035546  -9.059  &lt; 2e-16 ***
## temp         0.0957375  0.0191719   4.994 5.93e-07 ***
## depth        0.9963667  0.2239745   4.449 8.64e-06 ***
## cond         0.0027675  0.0009828   2.816  0.00486 ** 
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for binomial family taken to be 1)
## 
##     Null deviance: 1074.79  on 777  degrees of freedom
## Residual deviance:  936.89  on 773  degrees of freedom
##   (68 observations deleted due to missingness)
## AIC: 946.89
## 
## Number of Fisher Scoring iterations: 3</code></pre>
<p>The summary function generates output very similar to what we’ve observed with linear modeling. The Estimate column shows us the parameter estimate for our different model parameters, and we can also get an indication of whether the parameters are considered to be significant, e.g., with p-values less than 0.05. Here, we see that all the parameters are considered significant, except for conductivity.</p>
<p>But how do we interpret the model coefficient values? Let’s look at these values again:</p>
<div class="sourceCode" id="cb348"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extracting model coefficients</span></span>
<span><span class="va">glm.bin</span><span class="op">$</span><span class="va">coefficients</span></span></code></pre></div>
<pre><code>##  (Intercept)       secchi         temp        depth         cond 
## -1.203602861 -0.032202531  0.095737510  0.996366684  0.002767454</code></pre>
<p>Because logistic regression involves the logit link function, it’s not as easy as with linear modeling. Here, the coefficient values can be interpreted as the additive effect of, for example, temperature on the <strong>log odds</strong> of success.</p>
<p>The <strong>odds ratio</strong> is more interpretable than the log odds. We get this by taking the inverse natural log of the coefficicent values, in other words raising e to the power of the coefficients. In R, we use the <code><a href="https://rdrr.io/r/base/Log.html">exp()</a></code> function to do this.</p>
<div class="sourceCode" id="cb350"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">glm.bin</span><span class="op">$</span><span class="va">coefficient</span><span class="op">)</span></span></code></pre></div>
<pre><code>## (Intercept)      secchi        temp       depth        cond 
##   0.3001110   0.9683104   1.1004702   2.7084234   1.0027713</code></pre>
<p>These values indicate that the odds of occurrence are 2.71 times (or 171% higher) when depth increases by a meter.</p>
<p>We can now use ggplot to generate a graph of these model results looking at the effect of depth on Carp occurrence probability. Note, however, that this is only approximate, as our model also included other parameters, and this plot merely considers depth.</p>
<div class="sourceCode" id="cb352"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">fish_binary</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">depth</span>, y <span class="op">=</span> <span class="va">CARP</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">0.05</span>, width <span class="op">=</span> <span class="fl">0.05</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">stat_smooth</a></span><span class="op">(</span></span>
<span>    method <span class="op">=</span> <span class="st">"glm"</span>,</span>
<span>    method.args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>family <span class="op">=</span> <span class="va">binomial</span><span class="op">)</span>,</span>
<span>    se <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Depth (m)"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Probability of presence"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Probability of presence of  Carp as a function of depth"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## `geom_smooth()` using formula = 'y ~ x'</code></pre>
<div class="inline-figure"><img src="usace_R_training_files/figure-html/unnamed-chunk-59-1.png" width="600" height="600"></div>
</div>
<div id="glm-with-the-tidymodels-package" class="section level4" number="16.2.1.3">
<h4>
<span class="header-section-number">16.2.1.3</span> GLM with the tidymodels package<a class="anchor" aria-label="anchor" href="#glm-with-the-tidymodels-package"><i class="fas fa-link"></i></a>
</h4>
<p>In R, for certain kinds of analysis, there may be different packages that can perform the same statistical procedures, but have different strengths. For our simple glm of CARP, the <code>glm</code> function in base R works well, but as model complexity increases there may be instances where additional capacities make sense. One package that enables this is the <code>tidymodels</code> package, so we’ll first introduce it here, so that we can come back to it later. The following code implements the same type of analysis, but now using tidymodels code.</p>
<div class="sourceCode" id="cb354"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required libraries</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">fish_binary</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>species <span class="op">=</span> <span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split the data into training and testing sets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">data</span>, prop <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify the model: GLM for regression</span></span>
<span><span class="va">glm_spec</span> <span class="op">&lt;-</span> <span class="fu">linear_reg</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_engine</span><span class="op">(</span><span class="st">"glm"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">set_mode</span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Define a recipe: Preprocessing steps</span></span>
<span><span class="va">glm_recipe</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">species</span> <span class="op">~</span> <span class="va">secchi</span> <span class="op">+</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">depth</span> <span class="op">+</span> <span class="va">current</span> <span class="op">+</span> <span class="va">do</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_normalize</span><span class="op">(</span><span class="fu">all_numeric_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create a workflow</span></span>
<span><span class="va">glm_workflow</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">glm_recipe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">glm_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Perform 10-fold cross-validation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">cv_splits</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">train_data</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the model with cross-validation</span></span>
<span><span class="va">cv_results</span> <span class="op">&lt;-</span> <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>  <span class="va">glm_workflow</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">cv_splits</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">rsq</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># View cross-validation metrics</span></span>
<span><span class="fu">collect_metrics</span><span class="op">(</span><span class="va">cv_results</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Finalize the model on the entire training set</span></span>
<span><span class="va">final_glm</span> <span class="op">&lt;-</span> <span class="fu">fit</span><span class="op">(</span><span class="va">glm_workflow</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Test the finalized model on the testing set</span></span>
<span><span class="va">test_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_glm</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">species</span>, estimate <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#print(test_results)</span></span>
<span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">results</span>, <span class="va">test_results</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>What if we want to model counts?</p>
<div class="sourceCode" id="cb355"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load required libraries</span></span>
<span><span class="va">umr_sub</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">LMBS</span>, <span class="va">secchi</span><span class="op">:</span><span class="va">do</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>cols <span class="op">=</span> <span class="va">secchi</span><span class="op">:</span><span class="va">do</span>, names_to <span class="op">=</span> <span class="st">"variable"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">LMBS</span><span class="op">)</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html">geom_jitter</a></span><span class="op">(</span>height <span class="op">=</span> <span class="fl">.05</span>, pch <span class="op">=</span> <span class="fl">21</span>, alpha <span class="op">=</span><span class="fl">0.5</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span>method <span class="op">=</span> <span class="st">"glm"</span><span class="op">)</span><span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">variable</span>, nrow <span class="op">=</span> <span class="fl">2</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb356"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm.poisson</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/glm.html">glm</a></span><span class="op">(</span><span class="va">LMBS</span> <span class="op">~</span> <span class="va">secchi</span> <span class="op">+</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">depth</span> <span class="op">+</span> <span class="va">current</span> <span class="op">+</span> <span class="va">do</span>,</span>
<span>  data <span class="op">=</span> <span class="va">umr_sub</span>,</span>
<span>  family <span class="op">=</span> <span class="va">poisson</span><span class="op">)</span> <span class="co"># this is what makes it a Poisson GLM! Note the default link is log.</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span><span class="op">(</span><span class="va">glm.poisson</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
## Call:
## glm(formula = LMBS ~ secchi + temp + depth + current + do, family = poisson, 
##     data = umr_sub)
## 
## Coefficients:
##               Estimate Std. Error z value Pr(&gt;|z|)    
## (Intercept)  2.1876972  0.0730252  29.958  &lt; 2e-16 ***
## secchi       0.0060138  0.0003939  15.268  &lt; 2e-16 ***
## temp         0.0305910  0.0024742  12.364  &lt; 2e-16 ***
## depth       -0.1558713  0.0317927  -4.903 9.45e-07 ***
## current     -1.7909347  0.1238641 -14.459  &lt; 2e-16 ***
## do           0.0262556  0.0042626   6.160 7.30e-10 ***
## ---
## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
## 
## (Dispersion parameter for poisson family taken to be 1)
## 
##     Null deviance: 10137.7  on 496  degrees of freedom
## Residual deviance:  9474.3  on 491  degrees of freedom
##   (349 observations deleted due to missingness)
## AIC: 11573
## 
## Number of Fisher Scoring iterations: 5</code></pre>
<div class="sourceCode" id="cb358"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">glm.poisson</span><span class="op">$</span><span class="va">coefficients</span></span></code></pre></div>
<p>To interpret these coefficients, we can say that for a one-unit increase in current, the log count of
Y increases significantly by 5.246739516, or the expected count increases by 189.85
exp(5.246739516)≈189.85. A one-unit increase in current is a lot on this scale, though so it may be better to consider that a 0.1 m/s increase in current increases counts by about 19 fish</p>
<p>Tidymodels version</p>
<div class="sourceCode" id="cb359"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/tidymodels/poissonreg">poissonreg</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">results_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">umr_sub</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>count <span class="op">=</span> <span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Split the data into training and testing sets</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">data_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">data</span>, prop <span class="op">=</span> <span class="fl">0.8</span><span class="op">)</span></span>
<span><span class="va">train_data</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span><span class="va">test_data</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">data_split</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify the model: Poisson Regression</span></span>
<span><span class="va">poisson_spec</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://parsnip.tidymodels.org/reference/poisson_reg.html">poisson_reg</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"glm"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op">(</span><span class="st">"regression"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify the model: Negative Binomial Regression</span></span>
<span><span class="co">#nb_spec &lt;- gen_additive_mod() %&gt;%</span></span>
<span> <span class="co"># set_engine("glm", family = MASS::negative.binomial(theta = 1)) %&gt;%</span></span>
<span>  <span class="co">#set_mode("regression")</span></span>
<span></span>
<span><span class="co"># Define a recipe: Preprocessing steps</span></span>
<span><span class="va">reg_recipe</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">secchi</span> <span class="op">+</span> <span class="va">temp</span> <span class="op">+</span> <span class="va">depth</span> <span class="op">+</span> <span class="va">current</span> <span class="op">+</span> <span class="va">do</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_normalize</span><span class="op">(</span><span class="fu">all_numeric_predictors</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create workflows</span></span>
<span><span class="va">poisson_workflow</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">reg_recipe</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">poisson_spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#nb_workflow &lt;- workflow() %&gt;%</span></span>
<span> <span class="co"># add_recipe(reg_recipe) %&gt;%</span></span>
<span>  <span class="co">#add_model(nb_spec)</span></span>
<span></span>
<span><span class="co"># Perform 10-fold cross-validation</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">cv_splits</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">train_data</span>, v <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the Poisson model with cross-validation</span></span>
<span><span class="va">poisson_cv_results</span> <span class="op">&lt;-</span> <span class="fu">fit_resamples</span><span class="op">(</span></span>
<span>  <span class="va">poisson_workflow</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">cv_splits</span>,</span>
<span>  metrics <span class="op">=</span> <span class="fu">metric_set</span><span class="op">(</span><span class="va">rmse</span>, <span class="va">mae</span>, <span class="va">rsq</span><span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu">control_resamples</span><span class="op">(</span>save_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Fit the Negative Binomial model with cross-validation</span></span>
<span><span class="co"># nb_cv_results &lt;- fit_resamples(</span></span>
<span><span class="co">#   nb_workflow,</span></span>
<span><span class="co">#   resamples = cv_splits,</span></span>
<span><span class="co">#   metrics = metric_set(rmse, mae, rsq),</span></span>
<span><span class="co">#   control = control_resamples(save_pred = TRUE)</span></span>
<span><span class="co"># )</span></span>
<span></span>
<span><span class="co"># View cross-validation metrics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html">print</a></span><span class="op">(</span><span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/cat.html">cat</a></span><span class="op">(</span><span class="st">"Poisson Regression Metrics:\n"</span><span class="op">)</span></span>
<span><span class="fu">collect_metrics</span><span class="op">(</span><span class="va">poisson_cv_results</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#cat("\nNegative Binomial Regression Metrics:\n")</span></span>
<span><span class="co">#collect_metrics(nb_cv_results)</span></span>
<span></span>
<span><span class="co"># Finalize and test the Poisson model</span></span>
<span><span class="va">final_poisson</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">poisson_workflow</span>, data <span class="op">=</span> <span class="va">train_data</span><span class="op">)</span></span>
<span><span class="va">poisson_test_results</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">final_poisson</span>, <span class="va">test_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">test_data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">metrics</span><span class="op">(</span>truth <span class="op">=</span> <span class="va">count</span>, estimate <span class="op">=</span> <span class="va">.pred</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>sp <span class="op">=</span> <span class="va">species</span><span class="op">[</span><span class="va">i</span><span class="op">]</span>,</span>
<span>         model <span class="op">=</span> <span class="st">"pois"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Finalize and test the Negative Binomial model</span></span>
<span><span class="co">#final_nb &lt;- fit(nb_workflow, data = train_data)</span></span>
<span><span class="co">#nb_test_results &lt;- predict(final_nb, test_data) %&gt;%</span></span>
<span> <span class="co"># bind_cols(test_data) %&gt;%</span></span>
<span>  <span class="co">#metrics(truth = count, estimate = .pred) %&gt;%</span></span>
<span>  <span class="co">#mutate(sp = comm_sp[i],</span></span>
<span>   <span class="co">#      model = "nb")</span></span>
<span></span>
<span><span class="va">results_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">results_counts</span>, <span class="va">poisson_test_results</span><span class="op">)</span><span class="co">#, nb_test_results)</span></span>
<span></span>
<span><span class="op">}</span></span></code></pre></div>

</div>
</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="linear-models.html"><span class="header-section-number">15</span> Linear Models</a></div>
<div class="next"><a href="random-effects.html"><span class="header-section-number">17</span> Random Effects</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#generalized-linear-models"><span class="header-section-number">16</span> Generalized Linear Models</a></li>
<li><a class="nav-link" href="#generalized-linear-model-background"><span class="header-section-number">16.1</span> Generalized Linear Model Background</a></li>
<li>
<a class="nav-link" href="#logistic-regression"><span class="header-section-number">16.2</span> Logistic regression</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#example-logistic-regression-anaysis"><span class="header-section-number">16.2.1</span> Example logistic regression anaysis</a></li></ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Using R for ecological modeling in USACE</strong>" was written by Ed Stowe. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
