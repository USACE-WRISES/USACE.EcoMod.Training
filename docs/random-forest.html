<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>19 Random Forest | Using R for ecological modeling in USACE</title>
<meta name="author" content="Ed Stowe">
<meta name="generator" content="bookdown 0.42 with bs4_book()">
<meta property="og:title" content="19 Random Forest | Using R for ecological modeling in USACE">
<meta property="og:type" content="book">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="19 Random Forest | Using R for ecological modeling in USACE">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.8.0/transition.js"></script><script src="libs/bs3compat-0.8.0/tabs.js"></script><script src="libs/bs3compat-0.8.0/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<meta name="description" content="Adapted from this Carpentries workshop https://carpentries-incubator.github.io/r-ml-tabular-data/ Random forest portion here:...">
<meta property="og:description" content="Adapted from this Carpentries workshop https://carpentries-incubator.github.io/r-ml-tabular-data/ Random forest portion here:...">
<meta name="twitter:description" content="Adapted from this Carpentries workshop https://carpentries-incubator.github.io/r-ml-tabular-data/ Random forest portion here:...">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Using R for ecological modeling in USACE</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Course overview</a></li>
<li><a class="" href="required-set-up-for-the-course.html">Required set-up for the course</a></li>
<li class="book-part">Basic Training on R and RStudio</li>
<li><a class="" href="introduction-to-r-and-rstudio.html"><span class="header-section-number">1</span> Introduction to R and RStudio</a></li>
<li><a class="" href="data-visualization-with-ggplot2.html"><span class="header-section-number">2</span> Data Visualization with ggplot2</a></li>
<li><a class="" href="exploring-and-understanding-data.html"><span class="header-section-number">3</span> Exploring and understanding data</a></li>
<li><a class="" href="manipulating-tabular-data.html"><span class="header-section-number">4</span> Manipulating Tabular Data</a></li>
<li class="book-part">Ecological Modeling in R</li>
<li><a class="" href="conceptual-ecological-models.html"><span class="header-section-number">5</span> Conceptual Ecological Models</a></li>
<li><a class="" href="what-they-are-not.html"><span class="header-section-number">6</span> What they are not</a></li>
<li><a class="" href="misconceptions.html"><span class="header-section-number">7</span> Misconceptions</a></li>
<li><a class="" href="storytelling.html"><span class="header-section-number">8</span> Storytelling</a></li>
<li><a class="" href="art-of-conceptual-modeling-is-iterating.html"><span class="header-section-number">9</span> Art of conceptual modeling is iterating</a></li>
<li class="book-part">Habitat Models</li>
<li><a class="" href="background-on-habitat-models-in-usace.html"><span class="header-section-number">10</span> Background on habitat models in USACE</a></li>
<li><a class="" href="habitat-suitability-index-models-with-ecorest.html"><span class="header-section-number">11</span> Habitat Suitability Index models with ecorest</a></li>
<li><a class="" href="ecorest-web-app.html"><span class="header-section-number">12</span> Ecorest Web App</a></li>
<li><a class="" href="sensitivity-and-uncertainty-analysis-for-habitat-suitability-index-hsi-models.html"><span class="header-section-number">13</span> Sensitivity and uncertainty analysis for habitat suitability index (HSI) models</a></li>
<li><a class="" href="spatial-habitat-models.html"><span class="header-section-number">14</span> Spatial Habitat Models</a></li>
<li class="book-part">Linear Models</li>
<li><a class="" href="linear-models.html"><span class="header-section-number">15</span> Linear Models</a></li>
<li><a class="" href="generalized-linear-models.html"><span class="header-section-number">16</span> Generalized Linear Models</a></li>
<li><a class="" href="random-effects.html"><span class="header-section-number">17</span> Random Effects</a></li>
<li><a class="" href="generalized-additive-models.html"><span class="header-section-number">18</span> Generalized Additive Models</a></li>
<li class="book-part">Machine Learning</li>
<li><a class="active" href="random-forest.html"><span class="header-section-number">19</span> Random Forest</a></li>
<li><a class="" href="boosted-regression-trees.html"><span class="header-section-number">20</span> Boosted Regression Trees</a></li>
<li class="book-part">Other Modeling Approaches</li>
<li><a class="" href="population-modeling.html"><span class="header-section-number">21</span> Population Modeling</a></li>
<li><a class="" href="network-models-and-connectivity.html"><span class="header-section-number">22</span> Network Models and Connectivity</a></li>
<li><a class="" href="agent-based-models.html"><span class="header-section-number">23</span> Agent-based Models</a></li>
<li class="book-part">Models and decision-making</li>
<li><a class="" href="decision-support.html"><span class="header-section-number">24</span> Decision Support</a></li>
<li><a class="" href="annualizing-benefits-and-costs-with-ecorest-and-engrecon.html"><span class="header-section-number">25</span> Annualizing benefits and costs with ecorest and EngrEcon</a></li>
<li><a class="" href="ceica-chapter.html"><span class="header-section-number">26</span> Cost-Effectiveness and Incremental Cost Analysis (CEICA) with ecorest</a></li>
<li class="book-part">Models Integration</li>
<li><a class="" href="model-integration.html"><span class="header-section-number">27</span> Model Integration</a></li>
<li class="book-part">Other R applications</li>
<li><a class="" href="r-for-gis.html"><span class="header-section-number">28</span> R for GIS</a></li>
<li><a class="" href="intersect.html"><span class="header-section-number">29</span> Intersect</a></li>
<li><a class="" href="important-data-sources.html"><span class="header-section-number">30</span> Important data sources</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="random-forest" class="section level1" number="19">
<h1>
<span class="header-section-number">19</span> Random Forest<a class="anchor" aria-label="anchor" href="#random-forest"><i class="fas fa-link"></i></a>
</h1>
<p>Adapted from this Carpentries workshop
<a href="https://carpentries-incubator.github.io/r-ml-tabular-data/" class="uri">https://carpentries-incubator.github.io/r-ml-tabular-data/</a></p>
<p>Random forest portion here:
<a href="https://carpentries-incubator.github.io/r-ml-tabular-data/04-Decision-Forests/index.html" class="uri">https://carpentries-incubator.github.io/r-ml-tabular-data/04-Decision-Forests/index.html</a></p>
<p>Use tidymodels version</p>
<div id="learning-objectives-8" class="section level2" number="19.1">
<h2>
<span class="header-section-number">19.1</span> Learning objectives<a class="anchor" aria-label="anchor" href="#learning-objectives-8"><i class="fas fa-link"></i></a>
</h2>
<ul>
<li>Understand the value of MLs like random forest</li>
<li>Understand an overview of random forest</li>
<li>Understand the basic workflow of an ML</li>
<li>Learn to implement a simple random forest model</li>
</ul>
</div>
<div id="background-1" class="section level2" number="19.2">
<h2>
<span class="header-section-number">19.2</span> Background<a class="anchor" aria-label="anchor" href="#background-1"><i class="fas fa-link"></i></a>
</h2>
<div id="can-i-do-machine-learning" class="section level3" number="19.2.1">
<h3>
<span class="header-section-number">19.2.1</span> Can I do machine learning?<a class="anchor" aria-label="anchor" href="#can-i-do-machine-learning"><i class="fas fa-link"></i></a>
</h3>
<p>Yes. And it’s getting easier.</p>
</div>
<div id="what-is-it-actually" class="section level3" number="19.2.2">
<h3>
<span class="header-section-number">19.2.2</span> What is it actually?<a class="anchor" aria-label="anchor" href="#what-is-it-actually"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="when-would-it-be-good" class="section level3" number="19.2.3">
<h3>
<span class="header-section-number">19.2.3</span> When would it be good?<a class="anchor" aria-label="anchor" href="#when-would-it-be-good"><i class="fas fa-link"></i></a>
</h3>
<p>Prediction</p>
</div>
<div id="what-are-the-basic-steps" class="section level3" number="19.2.4">
<h3>
<span class="header-section-number">19.2.4</span> What are the basic steps<a class="anchor" aria-label="anchor" href="#what-are-the-basic-steps"><i class="fas fa-link"></i></a>
</h3>
<ul>
<li>Split</li>
<li>Tune and train</li>
<li>Assess</li>
<li>Predict</li>
</ul>
</div>
<div id="what-can-i-use-for-ml" class="section level3" number="19.2.5">
<h3>
<span class="header-section-number">19.2.5</span> What can I use for ML?<a class="anchor" aria-label="anchor" href="#what-can-i-use-for-ml"><i class="fas fa-link"></i></a>
</h3>
<p>Tons of packages in R and Python.</p>
<p>Tidymodels in R offers an integrated for framework for using a bunch of different MLs.</p>
</div>
<div id="how-does-random-forest-work" class="section level3" number="19.2.6">
<h3>
<span class="header-section-number">19.2.6</span> How does random forest work<a class="anchor" aria-label="anchor" href="#how-does-random-forest-work"><i class="fas fa-link"></i></a>
</h3>
<p>Decision trees start with a basic question, such as, “Should I surf?”
From there, you can ask a series of questions to determine an answer, such as, “Is it a long period swell?” or “Is the wind blowing offshore?”.</p>
<p>These questions make up the decision nodes in the tree, acting as a means to split the data.</p>
<p>Each question helps an individual to arrive at a final decision, which would be denoted by the leaf node.</p>
<p>Observations that fit the criteria will follow the “Yes” branch and those that don’t will follow the alternate path.</p>
<p>Decision trees seek to find the best split to subset the data, but tend to have problems: they are often biased and poor at making predictions. Random forest and other algorithms solve some of these problems.</p>
<p>Instead of a single tree, random forest creates many unique decision trees. It does this by:</p>
<p>Create Many Decision Trees: The algorithm makes many decision trees each using a random part of the data. So every tree is a bit different.</p>
<p>Pick Random predictors: When building each tree it doesn’t look at all the features (columns) at once. It picks a few at random to decide how to split the data, so each tree is unique.</p>
<p>Each Tree Makes a Prediction: Every tree gives its own answer or prediction based on what it learned from its part of the data.</p>
<p>Combine the Predictions:</p>
<p>For classification we choose a category as the final answer is the one that most trees agree on i.e majority voting.
For regression we predict a number as the final answer is the average of all the trees predictions.</p>
<p>Why It Works Well: Using random data and features for each tree helps avoid overfitting and makes the overall prediction more accurate and trustworthy.</p>
</div>
</div>
<div id="case-study" class="section level2" number="19.3">
<h2>
<span class="header-section-number">19.3</span> Case study<a class="anchor" aria-label="anchor" href="#case-study"><i class="fas fa-link"></i></a>
</h2>
<div id="quick-data-exploration" class="section level3" number="19.3.1">
<h3>
<span class="header-section-number">19.3.1</span> Quick data exploration<a class="anchor" aria-label="anchor" href="#quick-data-exploration"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="data-partitioning" class="section level3" number="19.3.2">
<h3>
<span class="header-section-number">19.3.2</span> Data partitioning<a class="anchor" aria-label="anchor" href="#data-partitioning"><i class="fas fa-link"></i></a>
</h3>
</div>
<div id="set-up-traintest-split" class="section level3" number="19.3.3">
<h3>
<span class="header-section-number">19.3.3</span> Set up train/test split<a class="anchor" aria-label="anchor" href="#set-up-traintest-split"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb360"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidymodels.tidymodels.org">tidymodels</a></span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">trees_split</span> <span class="op">&lt;-</span> <span class="fu">initial_split</span><span class="op">(</span><span class="va">trees_df</span>, strata <span class="op">=</span> <span class="va">legal_status</span><span class="op">)</span></span>
<span><span class="va">trees_train</span> <span class="op">&lt;-</span> <span class="fu">training</span><span class="op">(</span><span class="va">trees_split</span><span class="op">)</span></span>
<span><span class="va">trees_test</span> <span class="op">&lt;-</span> <span class="fu">testing</span><span class="op">(</span><span class="va">trees_split</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="pre-processing-with-recipes" class="section level3" number="19.3.4">
<h3>
<span class="header-section-number">19.3.4</span> Pre-processing with recipes<a class="anchor" aria-label="anchor" href="#pre-processing-with-recipes"><i class="fas fa-link"></i></a>
</h3>
<p>Build a recipe for data preprocessing.</p>
<p>First, we must tell the recipe() what our model is going to be (using a formula here) and what our training data is.
Next, we update the role for tree_id, since this is a variable we might like to keep around for convenience as an identifier for rows but is not a predictor or outcome.
Next, we use step_other() to collapse categorical levels for species, caretaker, and the site info. Before this step, there were 300+ species!
The date column with when each tree was planted may be useful for fitting this model, but probably not the exact date, given how slowly trees grow. Let’s create a year feature from the date, and then remove the original date variable.
There are many more DPW maintained trees than not, so let’s downsample the data for training.
The object tree_rec is a recipe that has not been trained on data yet (for example, which categorical levels should be collapsed has not been calculated) and tree_prep is an object that has been trained on data.</p>
<div class="sourceCode" id="cb361"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tree_rec</span> <span class="op">&lt;-</span> <span class="fu">recipe</span><span class="op">(</span><span class="va">legal_status</span> <span class="op">~</span> <span class="va">.</span>, data <span class="op">=</span> <span class="va">trees_train</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">update_role</span><span class="op">(</span><span class="va">tree_id</span>, new_role <span class="op">=</span> <span class="st">"ID"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_other</span><span class="op">(</span><span class="va">species</span>, <span class="va">caretaker</span>, threshold <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_other</span><span class="op">(</span><span class="va">site_info</span>, threshold <span class="op">=</span> <span class="fl">0.005</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_dummy</span><span class="op">(</span><span class="fu">all_nominal</span><span class="op">(</span><span class="op">)</span>, <span class="op">-</span><span class="fu">all_outcomes</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_date</span><span class="op">(</span><span class="va">date</span>, features <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"year"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_rm</span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">step_downsample</span><span class="op">(</span><span class="va">legal_status</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tree_prep</span> <span class="op">&lt;-</span> <span class="fu">prep</span><span class="op">(</span><span class="va">tree_rec</span><span class="op">)</span></span>
<span><span class="va">juiced</span> <span class="op">&lt;-</span> <span class="fu">juice</span><span class="op">(</span><span class="va">tree_prep</span><span class="op">)</span>  </span></code></pre></div>
</div>
<div id="model-specifications-with-parsnip" class="section level3" number="19.3.5">
<h3>
<span class="header-section-number">19.3.5</span> Model specifications with parsnip<a class="anchor" aria-label="anchor" href="#model-specifications-with-parsnip"><i class="fas fa-link"></i></a>
</h3>
<p>Tune some of the parameters.</p>
<div class="sourceCode" id="cb362"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_spec</span> <span class="op">&lt;-</span> </span>
<span>    <span class="fu"><a href="https://parsnip.tidymodels.org/reference/rand_forest.html">rand_forest</a></span><span class="op">(</span>mtry <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, min_n <span class="op">=</span> <span class="fu"><a href="https://hardhat.tidymodels.org/reference/tune.html">tune</a></span><span class="op">(</span><span class="op">)</span>, trees <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"ranger"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_args.html">set_mode</a></span><span class="op">(</span><span class="st">"classification"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="workflow" class="section level3" number="19.3.6">
<h3>
<span class="header-section-number">19.3.6</span> Workflow<a class="anchor" aria-label="anchor" href="#workflow"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb363"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tune_wf</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">tree_rec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">tune_spec</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="tune-hyperparameters---notes-from-julia-slige-httpsjuliasilge.comblogsf-trees-random-tuning" class="section level3" number="19.3.7">
<h3>
<span class="header-section-number">19.3.7</span> Tune hyperparameters - Notes from Julia Slige <a href="https://juliasilge.com/blog/sf-trees-random-tuning/" class="uri">https://juliasilge.com/blog/sf-trees-random-tuning/</a><a class="anchor" aria-label="anchor" href="#tune-hyperparameters---notes-from-julia-slige-httpsjuliasilge.comblogsf-trees-random-tuning"><i class="fas fa-link"></i></a>
</h3>
<p>Now it’s time to tune the hyperparameters for a random forest model. First, let’s create a set of cross-validation resamples to use for tuning.</p>
<div class="sourceCode" id="cb364"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">234</span><span class="op">)</span></span>
<span><span class="va">trees_folds</span> <span class="op">&lt;-</span> <span class="fu">vfold_cv</span><span class="op">(</span><span class="va">trees_train</span><span class="op">)</span></span></code></pre></div>
<p>We can’t learn the right values when training a single model, but we can train a whole bunch of models and see which ones turn out best. We can use parallel processing to make this go faster, since the different parts of the grid are independent. Let’s use grid = 20 to choose 20 grid points automatically.</p>
<div class="sourceCode" id="cb365"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">doParallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/doParallel/man/registerDoParallel.html">registerDoParallel</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">345</span><span class="op">)</span></span>
<span><span class="va">tune_res</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">tune_wf</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">trees_folds</span>,</span>
<span>  grid <span class="op">=</span> <span class="fl">20</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tune_res</span></span></code></pre></div>
<p>How did this turn out? Let’s look at AUC.</p>
<div class="sourceCode" id="cb366"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tune_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"roc_auc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">mean</span>, <span class="va">min_n</span>, <span class="va">mtry</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="va">min_n</span><span class="op">:</span><span class="va">mtry</span>,</span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span>,</span>
<span>    names_to <span class="op">=</span> <span class="st">"parameter"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">value</span>, <span class="va">mean</span>, color <span class="op">=</span> <span class="va">parameter</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>show.legend <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">parameter</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="cn">NULL</span>, y <span class="op">=</span> <span class="st">"AUC"</span><span class="op">)</span></span></code></pre></div>
<p>This grid did not involve every combination of min_n and mtry but we can get an idea of what is going on. It looks like higher values of mtry are good (above about 10) and lower values of min_n are good (below about 10). We can get a better handle on the hyperparameters by tuning one more time, this time using regular_grid(). Let’s set ranges of hyperparameters we want to try, based on the results from our initial tune.</p>
<div class="sourceCode" id="cb367"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rf_grid</span> <span class="op">&lt;-</span> <span class="fu">grid_regular</span><span class="op">(</span></span>
<span>  <span class="fu">mtry</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">30</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  <span class="fu">min_n</span><span class="op">(</span>range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  levels <span class="op">=</span> <span class="fl">5</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">rf_grid</span>  </span></code></pre></div>
</div>
<div id="choosing-the-best-model" class="section level3" number="19.3.8">
<h3>
<span class="header-section-number">19.3.8</span> Choosing the best model<a class="anchor" aria-label="anchor" href="#choosing-the-best-model"><i class="fas fa-link"></i></a>
</h3>
<p>It’s much more clear what the best model is now. We can identify it using the function select_best(), and then update our original model specification tune_spec to create our final model specification.</p>
<p>We can tune one more time, but this time in a more targeted way with this rf_grid.</p>
<div class="sourceCode" id="cb368"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html">set.seed</a></span><span class="op">(</span><span class="fl">456</span><span class="op">)</span></span>
<span><span class="va">regular_res</span> <span class="op">&lt;-</span> <span class="fu">tune_grid</span><span class="op">(</span></span>
<span>  <span class="va">tune_wf</span>,</span>
<span>  resamples <span class="op">=</span> <span class="va">trees_folds</span>,</span>
<span>  grid <span class="op">=</span> <span class="va">rf_grid</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">regular_res</span></span></code></pre></div>
<p>What the results look like now?</p>
<div class="sourceCode" id="cb369"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">regular_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.metric</span> <span class="op">==</span> <span class="st">"roc_auc"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>min_n <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">factor</a></span><span class="op">(</span><span class="va">min_n</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">mtry</span>, <span class="va">mean</span>, color <span class="op">=</span> <span class="va">min_n</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span>, size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"AUC"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">best_auc</span> <span class="op">&lt;-</span> <span class="fu">select_best</span><span class="op">(</span><span class="va">regular_res</span>, <span class="st">"roc_auc"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_rf</span> <span class="op">&lt;-</span> <span class="fu">finalize_model</span><span class="op">(</span></span>
<span>  <span class="va">tune_spec</span>,</span>
<span>  <span class="va">best_auc</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_rf</span></span></code></pre></div>
<p>Let’s explore our final model a bit. What can we learn about variable importance, using the vip package?</p>
<div class="sourceCode" id="cb370"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/koalaverse/vip/">vip</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_rf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://parsnip.tidymodels.org/reference/set_engine.html">set_engine</a></span><span class="op">(</span><span class="st">"ranger"</span>, importance <span class="op">=</span> <span class="st">"permutation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://generics.r-lib.org/reference/fit.html">fit</a></span><span class="op">(</span><span class="va">legal_status</span> <span class="op">~</span> <span class="va">.</span>,</span>
<span>    data <span class="op">=</span> <span class="fu">juice</span><span class="op">(</span><span class="va">tree_prep</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">tree_id</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://koalaverse.github.io/vip/reference/vip.html">vip</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span></span></code></pre></div>
<p>The private caretaker characteristic important in categorization, as is latitude and longitude. Interesting that year (i.e. age of the tree) is so important!</p>
<p>Let’s make a final workflow, and then fit one last time, using the convenience function last_fit(). This function fits a final model on the entire training set and evaluates on the testing set. We just need to give this funtion our original train/test split.</p>
<div class="sourceCode" id="cb371"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_wf</span> <span class="op">&lt;-</span> <span class="fu">workflow</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_recipe</span><span class="op">(</span><span class="va">tree_rec</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">add_model</span><span class="op">(</span><span class="va">final_rf</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_res</span> <span class="op">&lt;-</span> <span class="va">final_wf</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">last_fit</span><span class="op">(</span><span class="va">trees_split</span><span class="op">)</span></span>
<span></span>
<span><span class="va">final_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect_metrics</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The metrics for the test set look good and indicate we did not overfit during tuning.</p>
<p>Let’s bind our testing results back to the original test set, and make one more map. Where in San Francisco are there more or less incorrectly predicted trees?</p>
<div class="sourceCode" id="cb372"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">final_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">collect_predictions</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>correct <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">legal_status</span> <span class="op">==</span> <span class="va">.pred_class</span> <span class="op">~</span> <span class="st">"Correct"</span>,</span>
<span>    <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"Incorrect"</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_cols.html">bind_cols</a></span><span class="op">(</span><span class="va">trees_test</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">longitude</span>, <span class="va">latitude</span>, color <span class="op">=</span> <span class="va">correct</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">0.5</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>color <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"gray80"</span>, <span class="st">"darkred"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="generalized-additive-models.html"><span class="header-section-number">18</span> Generalized Additive Models</a></div>
<div class="next"><a href="boosted-regression-trees.html"><span class="header-section-number">20</span> Boosted Regression Trees</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#random-forest"><span class="header-section-number">19</span> Random Forest</a></li>
<li><a class="nav-link" href="#learning-objectives-8"><span class="header-section-number">19.1</span> Learning objectives</a></li>
<li>
<a class="nav-link" href="#background-1"><span class="header-section-number">19.2</span> Background</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#can-i-do-machine-learning"><span class="header-section-number">19.2.1</span> Can I do machine learning?</a></li>
<li><a class="nav-link" href="#what-is-it-actually"><span class="header-section-number">19.2.2</span> What is it actually?</a></li>
<li><a class="nav-link" href="#when-would-it-be-good"><span class="header-section-number">19.2.3</span> When would it be good?</a></li>
<li><a class="nav-link" href="#what-are-the-basic-steps"><span class="header-section-number">19.2.4</span> What are the basic steps</a></li>
<li><a class="nav-link" href="#what-can-i-use-for-ml"><span class="header-section-number">19.2.5</span> What can I use for ML?</a></li>
<li><a class="nav-link" href="#how-does-random-forest-work"><span class="header-section-number">19.2.6</span> How does random forest work</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#case-study"><span class="header-section-number">19.3</span> Case study</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#quick-data-exploration"><span class="header-section-number">19.3.1</span> Quick data exploration</a></li>
<li><a class="nav-link" href="#data-partitioning"><span class="header-section-number">19.3.2</span> Data partitioning</a></li>
<li><a class="nav-link" href="#set-up-traintest-split"><span class="header-section-number">19.3.3</span> Set up train/test split</a></li>
<li><a class="nav-link" href="#pre-processing-with-recipes"><span class="header-section-number">19.3.4</span> Pre-processing with recipes</a></li>
<li><a class="nav-link" href="#model-specifications-with-parsnip"><span class="header-section-number">19.3.5</span> Model specifications with parsnip</a></li>
<li><a class="nav-link" href="#workflow"><span class="header-section-number">19.3.6</span> Workflow</a></li>
<li><a class="nav-link" href="#tune-hyperparameters---notes-from-julia-slige-httpsjuliasilge.comblogsf-trees-random-tuning"><span class="header-section-number">19.3.7</span> Tune hyperparameters - Notes from Julia Slige https://juliasilge.com/blog/sf-trees-random-tuning/</a></li>
<li><a class="nav-link" href="#choosing-the-best-model"><span class="header-section-number">19.3.8</span> Choosing the best model</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Using R for ecological modeling in USACE</strong>" was written by Ed Stowe. </p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
